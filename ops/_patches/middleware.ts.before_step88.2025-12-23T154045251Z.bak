import { NextResponse, type NextRequest, NextRequest } from "next/server";

const HEALTH_PATHS = new Set([
  "/api/health",
  "/api/healthz",
  "/api/_health",
  "/api/emml/health",
  "/api/hybrid/health",
  "/api/ads/health",
]);

export function middleware(request: NextRequest) {    
  
  
  
  
  // Health handling (ungated, SAFE URL parsing):
  // - /api/_health is a legacy alias that MUST rewrite to /api/healthz (tests expect x-middleware-rewrite).
  // - /api/health, /api/healthz, /api/*/health must never be gated.
  const __origin =
    ((request as any).nextUrl && ((request as any).nextUrl as any).origin) ||
    (typeof (request as any).url === "string" && (() => { try { return new URL((request as any).url).origin; } catch { return ""; } })()) ||
    "http://localhost";
  const __p =
    ((request as any).nextUrl && ((request as any).nextUrl as any).pathname) ||
    (typeof (request as any).url === "string" ? (() => { try { return new URL((request as any).url, __origin).pathname; } catch { return ""; } })() : "");

  if (__p === "/api/_health") {
    // Build absolute rewrite target safely.
    let u: URL;
    const nu = ((request as any).nextUrl && typeof ((request as any).nextUrl.clone) === "function")
      ? ((request as any).nextUrl.clone() as URL)
      : new URL(((request as any).url ?? "/"), __origin);
    u = new URL(nu.toString());
    u.pathname = "/api/healthz";
    const r = NextResponse.rewrite(u);
    r.headers.set("cache-control", "no-store");
    r.headers.set("x-middleware-rewrite", "/api/healthz");
    return r;
  }

  if (__p === "/api/health" || __p === "/api/healthz" || (__p.startsWith("/api/") && __p.endsWith("/health"))) {
    return NextResponse.next();
  }


const { pathname } = request.nextUrl;

  // Always allow health endpoints (CI + probes) through all gates.
  if (HEALTH_PATHS.has(pathname)) return NextResponse.next();

  // Keep private-mode gating (existing behavior) by deferring to the legacy logic,
  // but only if a legacy function exists. Otherwise, no-op.
  const anyGlobal = globalThis as any;
  if (typeof anyGlobal.__lumora_legacy_middleware === "function") {
    return anyGlobal.__lumora_legacy_middleware(request);
  }

  return NextResponse.next();
}

// Match all API routes plus explicit /api/_health.

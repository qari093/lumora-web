import { NextRequest, NextResponse } from "next/server";

function parseList(v: string): string[] {
  return v
    .split(",")
    .map((s) => s.trim().toLowerCase())
    .filter(Boolean)
    .filter((s) => s.includes("@"));
}

function safeEq(a: string, b: string): boolean {
  // constant-time-ish compare for same length strings
  if (a.length !== b.length) return false;
  let out = 0;
  for (let i = 0; i < a.length; i++) out |= a.charCodeAt(i) ^ b.charCodeAt(i);
  return out === 0;
}

function envToken(): string {
  return (process.env.LUMORA_PRIVATE_ACCESS_TOKEN || process.env.PRIVATE_ACCESS_TOKEN || "").trim();
}

function allowlist(): string[] {
  const raw = (process.env.LUMORA_PRIVATE_ALLOWLIST || process.env.PRIVATE_ALLOWLIST || "").trim();
  return parseList(raw);
}

function isPrivateMode(): boolean {
  const launchMode = (process.env.LAUNCH_MODE || process.env.LUMORA_LAUNCH_MODE || "").toLowerCase();
  const publicAccess = (process.env.PUBLIC_ACCESS || process.env.LUMORA_PUBLIC_ACCESS || "").trim();
  return launchMode === "private" || publicAccess === "0";
}

function setEmailCookie(res: NextResponse, email: string) {
  res.cookies.set({
    name: "lumora_email",
    value: email.toLowerCase().trim(),
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/", // CRITICAL: must be sent to "/"
    maxAge: 60 * 60 * 24 * 30, // 30 days
  });
}

async function readJson(req: NextRequest): Promise<any | null> {
  try {
    if (!req.headers.get("content-type")?.includes("application/json")) return null;
    return await req.json();
  } catch {
    return null;
  }
}

async function handle(req: NextRequest) {
  if (!isPrivateMode()) {
    return NextResponse.json({ ok: false, error: "not_private_mode" }, { status: 400 });
  }

  const tok = envToken();
  const allow = allowlist();
  if (!tok) return NextResponse.json({ ok: false, error: "missing_server_token" }, { status: 500 });
  if (!allow.length) return NextResponse.json({ ok: false, error: "missing_allowlist" }, { status: 500 });

  const url = new URL(req.url);
  const qEmail = (url.searchParams.get("email") || "").trim().toLowerCase();
  const qToken = (url.searchParams.get("token") || "").trim();

  const body = (await readJson(req)) || {};
  const bEmail = typeof body.email === "string" ? body.email.trim().toLowerCase() : "";
  const bToken = typeof body.token === "string" ? body.token.trim() : "";

  const email = (qEmail || bEmail).trim().toLowerCase();
  const token = (qToken || bToken).trim();

  if (!email || !email.includes("@")) {
    return NextResponse.json({ ok: false, error: "missing_email" }, { status: 400 });
  }
  if (!token) {
    return NextResponse.json({ ok: false, error: "missing_token" }, { status: 400 });
  }
  if (!safeEq(token, tok)) {
    return NextResponse.json({ ok: false, error: "bad_token" }, { status: 401 });
  }
  if (!allow.includes(email)) {
    return NextResponse.json({ ok: false, error: "not_allowlisted" }, { status: 403 });
  }

  const res = NextResponse.json({ ok: true, email }, { status: 200 });
  setEmailCookie(res, email);
  return res;
}

export async function GET(req: NextRequest) {
  return handle(req);
}

export async function POST(req: NextRequest) {
  return handle(req);
}
